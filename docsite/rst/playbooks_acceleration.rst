アクセラレートモード
==================

.. versionadded:: 1.3

この機能は不要かも！
````````````````````````

Ansible 1.5 以降を実行していますか？実行していれば、"SSH パイプライン" と呼ばれる新しい機能があり、アクセラレートモードは不要かもしれません。ドキュメントの :ref:`pipelining` セクションを読むべきです。

1.5 以降のユーザにとって、アクセラレートモードは (A) paramiko が使われている Enterprise Linux 6 以前のホストを管理するか、(B) パイプラインドキュメントに記述されているような sudo で TTY を有効に出来ない場合にのみ意味があります。

もしパイプラインを使用できれば、Ansible はファイル転送量を減らして、効率を良くし、アクセラレートモードを使用するほとんどすべてのケースにおいてパフォーマンスを向上し、とても大きなファイル転送を遮断する事ができます。less moving parts は複雑なため、ほとんどすべてのケースにおいてはアクセラレートモードよりもパイプラインの方がよいでしょう。

アクセラレートモードは　EL6 の管理マシンと、その他制限付き環境のサポートを中心に残されています。

アクセラレートモードの詳細
````````````````````````

OpenSSH が ControlPersist 機能を使用している間はとても速くてスケーラブルで、SSH 接続の使用にともなったオーバーヘッドが少なくなります。（EL6 管理マシンのような） 多くの人は必要性な場面には出会わないかもしれませんが、例えば ControlPersist をサポートしないプラットフォームで実行している場合、おそらくチューニングオプションに興味を持つことでしょう。

アクセラレートモードは接続速度を向上させるのに役立ちますが、最初のセキュア鍵交換には SSH を使用します。管理するための公開鍵インフラを追加する必要はなく、 NTP や DNS のようなものでさえ不要です。

アクセラレートモードは ControlPersist の SSH よりも 2-6倍、paramiko よりも 10倍速いです。

アクセラレートモードは SSH 上に一時的なデーモンを起動する事によって動作します。一度デーモンが動作すれば、Ansible はソケット接続を通じて直接接続します。Ansible は SSH 接続で交換される一時的な AES キー（このキーはすべてのホストで異なり、定期的に再生成される）を使用して安全な通信を行います。

通常、Ansible はアクセラレートモードの接続にポート 5099 を使用しますが、この値は変更可能です。一度動作すれば、デーモンは 30 分間接続を受け付け、その後は一旦接続を終了して、また SSH で再開します。

アクセラレートモードにはオリジナルの fireball モード（将来廃止予定）からいくつかの改善点があります。:

* ブートスラッピングは必要ではなく、アクセラレートモードでは実行したい各 play ごとに一つの行のみ追加される必要があります。
* sudo コマンドのサポートがあります（より詳細と注意点を後述で参照）。
* 必須条件が少なくなりました。ZeroMQ はもはや不要で、特別なパッケージの python-keyczar でさえ不要です。
* python 2.5 以上が必要です。

アクセラレートモードを使用するためには、playbook に `accelerate: true` を追加するだけです。::

    ---

    - hosts: all
      accelerate: true

      tasks:

      - name: いくつかのタスク
        command: echo {{ item }}
        with_items:
        - foo
        - bar
        - baz

アクセラレート接続のために Ansible のポートを変更したい場合、 `accelerated_port` オプションを追加します。::

    ---

    - hosts: all
      accelerate: true
      # default port is 5099
      accelerate_port: 10000

また、`accelerate_port` オプションは環境変数または `ansible.cfg` 設定の  ACCELERATE_PORT に指定可能です。::

    [accelerate]
    accelerate_port = 5099

上記の注意として、アクセラレートモードは sudo 経由のタスク実行をサポートしていますが、２つ注意点があります。:

* sudoers オプションから必須指定を削除する必要があります。
* sudo パスワードのプロンプトはまだサポートされていないため、sudo のコマンドのために NOPASSWD オプションが必要です。

Ansible バージョン 1.6 では、複数の Ansible 管理ノードから接続するための複数のキーの使用が出来ます。そのためには、次のオプションを `ansible.cfg` の設定に追加する必要があります。::

    accelerate_multi_key = yes

有効であれば、デーモンは UNIX ソケットファイル（通常、`$ANSIBLE_REMOTE_TEMP/.ansible-accelerate/.local.socket`) を開きます。SSH 上の新しい接続は新しいキーをデーモンにアップロードするためにこのソケットファイルを利用できます。
